<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Fair Four Picker</title>
<meta name="description" content="フェアプレイを支援するメンバー自動割り当てアプリ" />
<style>
:root{
  --green-1:#0a8f3a;
  --green-2:#0f6e2f;
  --card:#ffffff;
  --ink:#0b1b14;
  --muted:#5b6b61;
  --accent:#1ea65f;
  --danger:#d7263d;
  --shadow: 0 6px 20px rgba(0,0,0,0.18);
  --radius:14px;
}
html,body{
  margin:0;
  padding:0;
  background: radial-gradient(1200px 800px at 50% -10%, #14a055 0%, var(--green-1) 35%, var(--green-2) 100%);
  color:var(--ink);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", Meiryo, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
.wrap{
  max-width:960px;
  margin:0 auto;
  padding: max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(28px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left));
}
header{
  display:flex;
  align-items:center;
  gap:10px;
  margin: 6px 4px 14px;
  color:#fff;
}
.logo{
  width:44px;
  height:44px;
  min-width:44px;
  border-radius:50%;
  display:grid;
  place-items:center;
  font-size:24px;
  background:rgba(255,255,255,0.14);
  box-shadow: var(--shadow);
  border:1px solid rgba(255,255,255,0.25)
}
h1{ font-size:20px; line-height:1.2; margin:0 }
.sub{ font-size:12px; opacity:.9 }

.pitch{
  position:relative;
  border-radius:18px;
  border:2px solid rgba(255,255,255,0.25);
  overflow:hidden;
  margin: 0 4px 16px;
  padding: 14px;
  background:
    linear-gradient(0deg, rgba(255,255,255,0.06), rgba(255,255,255,0.06)) 0 0 / 100% 2px no-repeat,
    linear-gradient(0deg, rgba(255,255,255,0.06), rgba(255,255,255,0.06)) 0 100% / 100% 2px no-repeat,
    linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.06)) 0 0 / 2px 100% no-repeat,
    linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.06)) 100% 0 / 2px 100% no-repeat,
    radial-gradient(circle at 50% 50%, rgba(255,255,255,0.2) 0 2px, transparent 3px) 50% 50%/ 100% 100% no-repeat,
    linear-gradient(90deg, rgba(255,255,255,0.2), rgba(255,255,255,0.2)) 50% 0/2px 100% no-repeat;
}
.card{
  background:var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding:14px;
  margin: 10px 4px;
}
label{ font-size:13px; color:var(--ink); display:block; margin-bottom:6px }
input[type="text"], input[type="number"]{
  width:100%;
  border:1px solid #dfe7e2;
  background:#fff;
  color:var(--ink);
  border-radius:10px;
  padding:12px 12px;
  font-size:16px;
  outline:none;
  box-shadow: inset 0 1px 0 rgba(0,0,0,0.03);
}
input[type="radio"]{ width:18px; height:18px; }
.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end }
.actions{ display:flex; gap:10px; flex-wrap:wrap }
button{
  appearance:none;
  border:0;
  border-radius:12px;
  padding:12px 16px;
  font-weight:700;
  font-size:16px;
  background:var(--accent);
  color:#fff;
  box-shadow: var(--shadow);
  cursor:pointer;
}
button.secondary{ background:#f1f5f3; color:#0d3b28 }
button.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.6); color:#fff }
button:disabled{ opacity:.6; cursor:not-allowed }
.member-list{ display:grid; grid-template-columns: 1fr; gap:8px; }
.member-row{ display:flex; gap:10px; align-items:center; }
.member-row .name{ flex:1 1 auto; min-width:0 }
.flags{ display:flex; gap:10px; }
.flag-pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid #dfe7e2;
  background:#f7fbf8;
  font-size:13px;
  user-select:none;
}
.hint{ font-size:12px; color:var(--muted); margin-top:4px }
.grid{ display:grid; gap:10px; grid-template-columns: repeat( auto-fill, minmax(260px, 1fr) ); }
.match{ border-left:5px solid var(--accent); }
.match h3{ margin:0 0 8px; font-size:16px; color:#0d3b28 }
.line{ display:flex; gap:8px; margin:6px 0; flex-wrap:wrap }
.tag{ background:#eef7f1; color:#0b3e2a; padding:6px 10px; border-radius:999px; font-size:14px; font-weight:600 }
.role{ font-weight:700; color:#0b3e2a; margin-right:6px }
.muted{ color:var(--muted) }
.warn{ color:var(--danger); font-size:13px; }
.small{ font-size:12px }
.sticky-foot{ position:sticky; bottom:12px; display:flex; gap:8px; justify-content:flex-end; padding: 0 6px; }
.copy{ background:#0b3e2a; color:#d7ffea }
footer{ color:#e6fff2; font-size:12px; margin: 22px 8px; line-height:1.6 }
.footer-card{
  background: rgba(255,255,255,0.1);
  color:#fff;
  border:1px solid rgba(255,255,255,0.25);
  border-radius:12px;
  padding:10px 12px;
  margin-top:10px
}

/* 追加: サッカー演出系 */
.fx-toggles{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
.fx-toggles .toggle{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid #dfe7e2; background:#fff; color:#0b3e2a; font-size:13px; }
.fx-toggles input{ width:16px; height:16px }

#fairBadge{
  background:#0b3e2a;
  color:#eafff4;
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  display:inline-flex;
  align-items:center;
  gap:6px;
}

@keyframes wobble {
  0%,100%{ transform: rotate(0deg) }
  25%{ transform: rotate(8deg) }
  50%{ transform: rotate(-8deg) }
  75%{ transform: rotate(6deg) }
}
.yc{ display:inline-block; margin-right:6px; animation: wobble 1s ease-in-out 2; }

/* キックオフカウントダウン */
#kickoffOverlay{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background: rgba(0,0,0,0.35);
  z-index: 998;
  backdrop-filter: blur(2px);
}
.kick-bubble{
  background: rgba(255,255,255,0.96);
  color:#0b3e2a;
  border-radius:16px;
  padding:26px 30px;
  box-shadow: var(--shadow);
  text-align:center;
  min-width:220px;
}
#kickCount{
  font-size:44px;
  font-weight:800;
  line-height:1;
}
.kick-sub{ font-size:14px; color:#2d5c47; margin-top:6px }
.kick-ball{ font-size:34px; margin-top:8px; display:block }
@keyframes pop {
  0%{ transform: scale(0.6); opacity:.2 }
  60%{ transform: scale(1.15); opacity:1 }
  100%{ transform: scale(1); opacity:1 }
}
.pop{ animation: pop .5s ease both }

/* コンフェッティ用キャンバス */
#confettiCanvas{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index: 999;
  display:none;
}

/* 結果カードのフェードイン */
@keyframes reveal {
  0%{ transform: translateY(6px); opacity:0 }
  100%{ transform: translateY(0); opacity:1 }
}
.reveal .match{ animation: reveal .35s ease both }
.reveal .match:nth-child(1){ animation-delay:.02s }
.reveal .match:nth-child(2){ animation-delay:.06s }
.reveal .match:nth-child(3){ animation-delay:.10s }
.reveal .match:nth-child(4){ animation-delay:.14s }
.reveal .match:nth-child(5){ animation-delay:.18s }
.reveal .match:nth-child(6){ animation-delay:.22s }

</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo" aria-hidden="true">⚽️</div>
    <div>
      <h1>Fair Four Picker</h1>
      <div class="sub">フェアプレイを支援するメンバー自動割り当てアプリ</div>
    </div>
  </header>

  <div class="pitch">
    <div class="card">
      <div class="controls">

        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="fx-toggles">
            <label class="toggle"><input id="fxToggle" type="checkbox" checked />演出ON</label>
            <label class="toggle"><input id="soundToggle" type="checkbox" checked />サウンドON</label>
          </div>
          <div class="actions">
            <button id="fillSample" class="secondary">サンプル入力</button>
            <button id="clearAll" class="secondary">入力クリア</button>
          </div>
        </div>

        <div>
          <label>参加メンバー（4〜8人）</label>
          <div id="memberList" class="member-list">
            <div class="member-row">
              <input id="name-1" class="name" type="text" placeholder="メンバー1（例：こうたろう）" />
              <div class="flags">
                <label class="flag-pill"><input id="gk-1" type="radio" name="role-1" value="GK" />GK</label>
                <label class="flag-pill"><input id="fp-1" type="radio" name="role-1" value="FP" />FP</label>
              </div>
            </div>
            <div class="member-row">
              <input id="name-2" class="name" type="text" placeholder="メンバー2（例：けんすけ）" />
              <div class="flags">
                <label class="flag-pill"><input id="gk-2" type="radio" name="role-2" value="GK" />GK</label>
                <label class="flag-pill"><input id="fp-2" type="radio" name="role-2" value="FP" />FP</label>
              </div>
            </div>
            <div class="member-row">
              <input id="name-3" class="name" type="text" placeholder="メンバー3（例：りゅうき）" />
              <div class="flags">
                <label class="flag-pill"><input id="gk-3" type="radio" name="role-3" value="GK" />GK</label>
                <label class="flag-pill"><input id="fp-3" type="radio" name="role-3" value="FP" />FP</label>
              </div>
            </div>
            <div class="member-row">
              <input id="name-4" class="name" type="text" placeholder="メンバー4（例：りゅうま）" />
              <div class="flags">
                <label class="flag-pill"><input id="gk-4" type="radio" name="role-4" value="GK" />GK</label>
                <label class="flag-pill"><input id="fp-4" type="radio" name="role-4" value="FP" />FP</label>
              </div>
            </div>
            <div class="member-row">
              <input id="name-5" class="name" type="text" placeholder="メンバー5（任意）" />
              <div class="flags">
                <label class="flag-pill"><input id="gk-5" type="radio" name="role-5" value="GK" />GK</label>
                <label class="flag-pill"><input id="fp-5" type="radio" name="role-5" value="FP" />FP</label>
              </div>
            </div>
            <div class="member-row">
              <input id="name-6" class="name" type="text" placeholder="メンバー6（任意）" />
              <div class="flags">
                <label class="flag-pill"><input id="gk-6" type="radio" name="role-6" value="GK" />GK</label>
                <label class="flag-pill"><input id="fp-6" type="radio" name="role-6" value="FP" />FP</label>
              </div>
            </div>
            <div class="member-row">
              <input id="name-7" class="name" type="text" placeholder="メンバー7（任意）" />
              <div class="flags">
                <label class="flag-pill"><input id="gk-7" type="radio" name="role-7" value="GK" />GK</label>
                <label class="flag-pill"><input id="fp-7" type="radio" name="role-7" value="FP" />FP</label>
              </div>
            </div>
            <div class="member-row">
              <input id="name-8" class="name" type="text" placeholder="メンバー8（任意）" />
              <div class="flags">
                <label class="flag-pill"><input id="gk-8" type="radio" name="role-8" value="GK" />GK</label>
                <label class="flag-pill"><input id="fp-8" type="radio" name="role-8" value="FP" />FP</label>
              </div>
            </div>
          </div>
          <div class="hint">
            第1試合の手動割当（任意）：各メンバー行の「GK / FP」をラジオボタンで選択できます（どちらも未選択でもOK／複数GKが選ばれた場合は先頭のみ採用）。
          </div>
        </div>

        <div class="row">
          <div style="flex:1 1 180px; min-width:160px">
            <label for="matchCount">試合数（1〜10）</label>
            <input id="matchCount" type="number" min="1" max="10" value="3" inputmode="numeric" />
          </div>
          <div style="flex:1 1 220px; min-width:200px">
            <label for="seed">乱数シード（任意・同じ結果を再現したい時）</label>
            <input id="seed" type="text" placeholder="例）20240901 など。未入力なら毎回ランダム" />
          </div>
        </div>

        <div class="row">
          <div class="actions">
            <button id="gen">スケジュール作成</button>
          </div>
        </div>
        <div id="error" class="warn" role="alert" style="display:none"></div>
      </div>
    </div>

    <div id="result" class="card" style="display:none">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h2 style="margin:0; font-size:18px; color:#0d3b28">割当て結果</h2>
        <div class="row" style="align-items:center; gap:8px">
          <div id="fairBadge" aria-live="polite"></div>
          <div class="small muted" id="seedInfo"></div>
        </div>
      </div>

      <div id="warnings" class="warn" style="display:none; margin: 6px 0 10px"></div>

      <div id="matches" class="grid" aria-live="polite" aria-busy="false"></div>

      <div class="card" style="margin-top:14px; background:#f7fbf8">
        <div style="font-weight:700; margin-bottom:6px">出場サマリー</div>
        <div id="summary" class="stats"></div>
      </div>

      <div class="sticky-foot">
        <button id="copyText" class="copy">結果をテキストでコピー</button>
        <button id="shareBtn" class="ghost">共有</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-card">
      ルール要点:
      <ul>
        <li>各試合 4人：フィールドプレーヤー3名＋キーパー1名。</li>
        <li>前の試合に出られなかった人は、次の試合はFPを最も優先。</li>
        <li>前の試合でGKだった人は、次の試合はFPを優先。</li>
        <li>出来るだけ公平になるように、出場数とGK回数が均されるよう自動調整。</li>
        <li>制約が同時に多すぎる場合（例：FP優先が4人以上）は、やむを得ず一部の希望を満たせないことがあります。その際はアプリが明示します。</li>
      </ul>
    </div>
    <div class="footer-card" style="margin-top:10px">
      このアプリは CC0（著作権放棄・No Rights Reserved）相当で提供します。出典不要・改変・再配布も自由にご利用ください。
    </div>
    <div style="margin-top:10px">Created by Naomitchy</div>
  </footer>
</div>

<!-- キックオフ演出 -->
<div id="kickoffOverlay" aria-hidden="true">
  <div class="kick-bubble">
    <div id="kickCount" class="pop">3</div>
    <div class="kick-sub">キックオフまで</div>
    <span class="kick-ball" aria-hidden="true">⚽️</span>
  </div>
</div>
<!-- コンフェッティ -->
<canvas id="confettiCanvas"></canvas>

<script>
const $ = sel => document.querySelector(sel);

function seedFromString(str){
  if(!str) return null;
  let h = 2166136261 >>> 0;
  for(let i=0; i<str.length; i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function mulberry32(a) {
  return function() {
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  }
}
function shuffleInPlace(arr, rng){
  for(let i = arr.length -1; i>0; i--){
    const j = Math.floor(rng()* (i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function escapeHTML(str){
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}

// メンバー行の読み取り
function getMembers(){
  const list = [];
  for(let i=1;i<=8;i++){
    const name = ($('#name-'+i)?.value || '').trim();
    const gk = !!document.getElementById('gk-'+i)?.checked; // radio
    const fp = !!document.getElementById('fp-'+i)?.checked; // radio
    list.push({ idx:i, name, gk, fp });
  }
  return list;
}
// ユニーク名リスト（先に入力された方を優先）
function getUniqueNames(){
  const mem = getMembers();
  const seen = new Set();
  const names = [];
  for(const m of mem){
    if(!m.name) continue;
    if(!seen.has(m.name)){
      seen.add(m.name);
      names.push(m.name);
    }
  }
  return names;
}
// 第1試合 事前割当（ラジオ）読み取り・検証
function readFirstMatchPreset(names){
  const mem = getMembers();
  const warnings = [];
  // 空欄にフラグが付いていたら無視
  for(const m of mem){
    if(!m.name && (m.gk || m.fp)){
      warnings.push(`空欄の行（#${m.idx}）に付いたフラグは無視しました`);
    }
  }
  // 重複名の後続行は無視（先行行を優先）
  const seen = new Set();
  const uniqRows = [];
  for(const m of mem){
    if(!m.name) continue;
    if(seen.has(m.name)){
      if(m.gk || m.fp){
        warnings.push(`重複名 "${m.name}"（#${m.idx}）のフラグは先の入力を優先し無視しました`);
      }
      continue;
    }
    seen.add(m.name);
    if(names.includes(m.name)){
      uniqRows.push(m);
    }
  }
  // GKは最大1人：複数選択なら先に出現した1人を採用
  const gkCandidates = uniqRows.filter(r => r.gk).map(r => r.name);
  let gk = null;
  if(gkCandidates.length > 1){
    gk = gkCandidates[0];
    warnings.push(`第1試合GKが複数に選択されていたため "${gk}" のみ採用しました`);
  }else if(gkCandidates.length === 1){
    gk = gkCandidates[0];
  }
  // FPは最大3人：超過は先に出現した3人のみ採用
  const fpCandidates = uniqRows.filter(r => r.fp).map(r => r.name);
  let fps = fpCandidates.slice(0,3);
  if(fpCandidates.length > 3){
    warnings.push(`第1試合FPが4人以上に選択されていたため、先頭の3人のみ採用しました（${fps.join('、')}）`);
  }
  // GKとFPの重複があればFPから外す
  if(gk && fps.includes(gk)){
    fps = fps.filter(n => n !== gk);
    warnings.push(`"${gk}" はGKに指定されているため、FPから外しました`);
  }
  return { preset: { gk, fps }, warnings };
}

// スケジューラ本体
function generateSchedule(names, matchCount, seedStr, firstMatchPreset){
  if(names.length < 4 || names.length > 8){
    throw new Error("参加メンバーは4〜8人で入力してください。");
  }
  if(matchCount < 1 || matchCount > 10){
    throw new Error("試合数は1〜10で入力してください。");
  }

  let seedInt = seedFromString(seedStr);
  if(seedInt == null){
    const buf = new Uint32Array(1);
    crypto.getRandomValues(buf);
    seedInt = buf[0] >>> 0;
  }
  const rng = mulberry32(seedInt);

  // プレイヤー状態
  const players = names.map((n, idx) => ({
    id: idx, name: n,
    matchesPlayed: 0, gkCount: 0, fpCount: 0,
    lastStatus: null, // 'FP' | 'GK' | 'BENCH'
    lastGKMatch: -9999
  }));

  const schedule = [];
  const warnings = [];
  const pickOrderRandom = (arr) => shuffleInPlace(arr.slice(), rng);

  for(let m = 1; m <= matchCount; m++){
    // 第1試合：事前指定があれば優先適用（不足は自動補完）
    if(m === 1 && firstMatchPreset && (firstMatchPreset.gk || (firstMatchPreset.fps && firstMatchPreset.fps.length))){
      let fps = [];
      let gk = null;
      if(firstMatchPreset.gk){
        gk = players.find(p => p.name === firstMatchPreset.gk) || null;
      }
      if(firstMatchPreset.fps && firstMatchPreset.fps.length){
        const used = new Set();
        for(const nm of firstMatchPreset.fps){
          const p = players.find(x => x.name === nm);
          if(p && (!gk || p !== gk) && !used.has(p.name) && fps.length < 3){
            fps.push(p); used.add(p.name);
          }
        }
      }
      // GK未指定なら残りから
      if(!gk){
        let gkCandidates = players.filter(p => !fps.includes(p));
        gkCandidates = pickOrderRandom(gkCandidates);
        gk = gkCandidates[0];
      }
      // FP不足分補充
      const remainForFP = players.filter(p => p !== gk && !fps.includes(p));
      const remainSorted = pickOrderRandom(remainForFP);
      while(fps.length < 3 && remainSorted.length > 0){
        fps.push(remainSorted.shift());
      }
      const activeSet = new Set([gk, ...fps]);
      const matchViolations = [];

      schedule.push({
        match: m,
        gk: gk.name,
        fps: fps.map(p => p.name),
        bench: players.filter(p => !activeSet.has(p)).map(p => p.name),
        violations: matchViolations
      });

      // 状態更新
      for(const p of players){
        if(p === gk){
          p.matchesPlayed += 1; p.gkCount += 1; p.lastStatus = 'GK'; p.lastGKMatch = m;
        }else if(fps.includes(p)){
          p.matchesPlayed += 1; p.fpCount += 1; p.lastStatus = 'FP';
        }else{
          p.lastStatus = 'BENCH';
        }
      }
      continue;
    }

    // 通常ロジック：前試合BENCHと前試合GKをFP優先（BENCHをより強く）
    const mustFP = players.filter(p => p.lastStatus === 'GK' || p.lastStatus === 'BENCH');
    const mustFPSorted = pickOrderRandom(mustFP).sort((a,b)=>{
      const ap = (a.lastStatus === 'BENCH') ? 0 : 1;
      const bp = (b.lastStatus === 'BENCH') ? 0 : 1;
      if(ap !== bp) return ap - bp;
      if(a.matchesPlayed !== b.matchesPlayed) return a.matchesPlayed - b.matchesPlayed;
      return 0;
    });

    const fps = [];
    const leftoverMust = [];
    for(const p of mustFPSorted){
      if(fps.length < 3){ fps.push(p); } else { leftoverMust.push(p); }
    }

    // GKは原則「前試合FP」から
    let gkCandidates = players.filter(p => p.lastStatus !== 'GK' && p.lastStatus !== 'BENCH');
    let forcedGKFromMust = false;
    if(gkCandidates.length === 0){
      gkCandidates = players.slice(); // 全員から
      forcedGKFromMust = true;
    }
    // GK選出の優先順位：GK回数少／直近GKでない／出場少
    gkCandidates = pickOrderRandom(gkCandidates).sort((a,b)=>{
      if(a.gkCount !== b.gkCount) return a.gkCount - b.gkCount;
      const gapA = (m - a.lastGKMatch);
      const gapB = (m - b.lastGKMatch);
      if(gapA !== gapB) return gapB - gapA;
      if(a.matchesPlayed !== b.matchesPlayed) return a.matchesPlayed - b.matchesPlayed;
      return 0;
    });
    // FPに既に選んだ人は避ける
    let gk = gkCandidates.find(p => !fps.includes(p));
    if(!gk){
      // どうしても見つからない → FPから1人をGKへスライド
      const prio = (x) => (x.lastStatus === 'FP') ? 0 : (x.lastStatus === 'GK') ? 1 : 2;
      const fpSortedForGK = fps.slice().sort((a,b)=>{
        const da = prio(a), db = prio(b);
        if(da !== db) return da - db;
        if(a.gkCount !== b.gkCount) return a.gkCount - b.gkCount;
        const gapA = (m - a.lastGKMatch);
        const gapB = (m - b.lastGKMatch);
        if(gapA !== gapB) return gapB - gapA;
        if(a.matchesPlayed !== b.matchesPlayed) return a.matchesPlayed - b.matchesPlayed;
        return 0;
      });
      gk = fpSortedForGK[0];
      const idx = fps.indexOf(gk);
      if(idx >= 0) fps.splice(idx,1);
      forcedGKFromMust = true;
    }

    // FP不足分を補充
    const remainForFP = players.filter(p => p !== gk && !fps.includes(p));
    const remainSorted = pickOrderRandom(remainForFP).sort((a,b)=>{
      if(a.matchesPlayed !== b.matchesPlayed) return a.matchesPlayed - b.matchesPlayed;
      return 0;
    });
    while(fps.length < 3 && remainSorted.length > 0){
      fps.push(remainSorted.shift());
    }

    const activeSet = new Set([gk, ...fps]);

    // 優先違反チェック（ベンチ優先をより強く）
    const matchViolations = [];
    for(const p of players){
      const isBenchPrev = (p.lastStatus === 'BENCH');
      if(isBenchPrev && !activeSet.has(p)){
        matchViolations.push(`${p.name}: 前試合ベンチ→今回ベンチ（本来FP優先）`);
      }
    }
    if(forcedGKFromMust && (gk.lastStatus === 'GK' || gk.lastStatus === 'BENCH')){
      const note = `${gk.name}: FP優先だったがGKに割当て`;
      if(!matchViolations.includes(note)) matchViolations.push(note);
    }
    if(matchViolations.length){
      warnings.push(`第${m}試合: 制約が多く一部の希望を満たせませんでした → ${matchViolations.join('、')}`);
    }

    schedule.push({
      match: m,
      gk: gk.name,
      fps: fps.map(p => p.name),
      bench: players.filter(p => !activeSet.has(p)).map(p => p.name),
      violations: matchViolations
    });

    // 状態更新
    for(const p of players){
      if(p === gk){
        p.matchesPlayed += 1; p.gkCount += 1; p.lastStatus = 'GK'; p.lastGKMatch = m;
      }else if(fps.includes(p)){
        p.matchesPlayed += 1; p.fpCount += 1; p.lastStatus = 'FP';
      }else{
        p.lastStatus = 'BENCH';
      }
    }
  }

  return {
    seed: seedInt,
    schedule,
    warnings,
    players: players.map(p => ({
      name: p.name,
      matchesPlayed: p.matchesPlayed,
      gkCount: p.gkCount,
      fpCount: p.matchesPlayed - p.gkCount
    }))
  };
}

// フェアネス評価
function computeFairness(data){
  const mp = data.players.map(p => p.matchesPlayed);
  const gk = data.players.map(p => p.gkCount);
  const spreadM = Math.max(...mp) - Math.min(...mp);
  const spreadG = Math.max(...gk) - Math.min(...gk);
  let score = 100 - (spreadM * 25 + spreadG * 20);
  score = Math.max(10, Math.min(100, score));
  let label = 'Excellent';
  if(score < 85) label = 'Good';
  if(score < 70) label = 'Fair';
  if(score < 55) label = 'Needs Balance';
  return { score: Math.round(score), label, spreadM, spreadG };
}

// レンダリング系
function renderResult(data){
  const result = document.getElementById('result');
  const matchesEl = document.getElementById('matches');
  const summaryEl = document.getElementById('summary');
  const warningsEl = document.getElementById('warnings');
  const seedInfo = document.getElementById('seedInfo');
  const fairBadge = document.getElementById('fairBadge');

  result.style.display = 'block';
  matchesEl.innerHTML = '';
  summaryEl.innerHTML = '';
  warningsEl.style.display = 'none';
  warningsEl.textContent = '';
  matchesEl.classList.remove('reveal'); // リセット

  // シード情報
  const seedStr = document.getElementById('seed').value.trim();
  if(seedStr){
    seedInfo.textContent = `再現シード: "${seedStr}" → ${data.seed}`;
  }else{
    seedInfo.textContent = `シード自動: ${data.seed}`;
  }

  // 警告まとめ
  if(data.warnings && data.warnings.length){
    warningsEl.style.display = 'block';
    warningsEl.textContent = data.warnings.join(' / ');
  }

  // 各試合
  for(const item of data.schedule){
    const card = document.createElement('div');
    card.className = 'card match';
    const fpLine = item.fps.map(n => `<span class="tag">${escapeHTML(n)}</span>`).join(' ');
    const benchLine = item.bench.map(n => `<span class="tag" style="background:#fff2f2; color:#8b1a1a">${escapeHTML(n)}</span>`).join(' ');
    const vio = (item.violations && item.violations.length)
      ? `<div class="small warn">注意: ${item.violations.map(escapeHTML).join(' / ')}</div>` : '';
    card.innerHTML = `
      <h3>第${item.match}試合</h3>
      <div class="line"><span class="role">GK</span> <span class="tag">${escapeHTML(item.gk)}</span></div>
      <div class="line"><span class="role">FP</span> ${fpLine}</div>
      <div class="line muted small">ベンチ: ${benchLine || '—'}</div>
      ${vio}
    `;
    matchesEl.appendChild(card);
  }

  // サマリー
  const playersSorted = data.players.slice().sort((a,b)=>{
    if(a.matchesPlayed !== b.matchesPlayed) return a.matchesPlayed - b.matchesPlayed;
    if(a.gkCount !== b.gkCount) return a.gkCount - b.gkCount;
    return a.name.localeCompare(b.name, 'ja');
  });
  const lines = playersSorted.map(p => {
    const benchCount = (data.schedule.length - p.matchesPlayed);
    return `<div class="p">・${escapeHTML(p.name)}：出場 ${p.matchesPlayed}（FP ${p.fpCount} / GK ${p.gkCount}）／ベンチ ${benchCount}</div>`;
  }).join('');
  summaryEl.innerHTML = lines;

  // フェアバッジ
  const fair = computeFairness(data);
  const warnIcon = (data.warnings && data.warnings.length) ? `<span class="yc" title="制約により一部希望が未反映">🟨</span>` : '';
  fairBadge.innerHTML = `${warnIcon}<span>フェア度 ${fair.score}/100</span><span style="opacity:.8">（出場差 ${fair.spreadM}・GK差 ${fair.spreadG}）</span>`;

  // 演出：カードのリビール
  matchesEl.classList.add('reveal');
}

// テキスト出力
function buildTextOutput(data){
  const seedStr = document.getElementById('seed').value.trim();
  const lines = [];
  lines.push('フェア分けサッカー（4人制：FP3・GK1）');
  lines.push(seedStr ? `シード: "${seedStr}" → ${data.seed}` : `シード自動: ${data.seed}`);
  lines.push('');
  for(const item of data.schedule){
    lines.push(`第${item.match}試合`);
    lines.push(` GK: ${item.gk}`);
    lines.push(` FP: ${item.fps.join(', ')}`);
    lines.push(` ベンチ: ${item.bench.join(', ') || '—'}`);
    if(item.violations && item.violations.length){
      lines.push(` 注意: ${item.violations.join(' / ')}`);
    }
    lines.push('');
  }
  lines.push('出場サマリー');
  const playersSorted = data.players.slice().sort((a,b)=>{
    if(a.matchesPlayed !== b.matchesPlayed) return a.matchesPlayed - b.matchesPlayed;
    if(a.gkCount !== b.gkCount) return a.gkCount - b.gkCount;
    return a.name.localeCompare(b.name, 'ja');
  });
  for(const p of playersSorted){
    const benchCount = data.schedule.length - p.matchesPlayed;
    lines.push(` ${p.name}: 出場 ${p.matchesPlayed}（FP ${p.fpCount} / GK ${p.gkCount}）／ベンチ ${benchCount}`);
  }
  return lines.join('\n');
}

// クリップボードコピー
async function copyToClipboard(text){
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(text);
      alert('結果をクリップボードにコピーしました。');
    }else{
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.setAttribute('readonly','');
      ta.style.position = 'fixed';
      ta.style.top = '-1000px';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      alert('結果をクリップボードにコピーしました。');
    }
  }catch(e){
    alert('コピーに失敗しました。手動でコピーしてください。');
  }
}

// 現在の入力から再生成（コピー/共有用）
function collectCurrentData(){
  const names = getUniqueNames();
  const matchCount = parseInt(document.getElementById('matchCount').value, 10);
  const seedStr = document.getElementById('seed').value.trim();
  const presetInfo = readFirstMatchPreset(names);
  const data = generateSchedule(names, matchCount, seedStr, presetInfo.preset);
  if(presetInfo.warnings.length){
    data.warnings = [...presetInfo.warnings, ...(data.warnings || [])];
  }
  return data;
}

/* =====================
   サッカー演出（SE/アニメ）
   ===================== */

// キックオフカウントダウン
function kickoffCountdown(){
  return new Promise(resolve=>{
    const overlay = document.getElementById('kickoffOverlay');
    const countEl = document.getElementById('kickCount');
    let n = 3;
    overlay.style.display = 'flex';
    countEl.textContent = n;
    countEl.classList.remove('pop');
    void countEl.offsetWidth; // reflow
    countEl.classList.add('pop');

    const tick = ()=>{
      n--;
      if(n > 0){
        countEl.textContent = n;
        countEl.classList.remove('pop'); void countEl.offsetWidth; countEl.classList.add('pop');
        setTimeout(tick, 500);
      }else{
        countEl.textContent = 'KICK OFF!';
        setTimeout(()=>{
          overlay.style.display = 'none';
          resolve();
        }, 450);
      }
    };
    setTimeout(tick, 600);
  });
}

// WebAudio 簡易SE
let audioCtx = null;
function getAudio(){
  if(!audioCtx){
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if(Ctx) audioCtx = new Ctx();
  }
  return audioCtx;
}
function playWhistle(){
  if(!$('#soundToggle')?.checked) return;
  const ctx = getAudio(); if(!ctx) return;
  const now = ctx.currentTime;
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  const vib = ctx.createOscillator();
  const vibGain = ctx.createGain();

  osc.type = 'sine';
  osc.frequency.setValueAtTime(1900, now);
  osc.frequency.exponentialRampToValueAtTime(1300, now + 0.55);

  vib.type = 'sine';
  vib.frequency.setValueAtTime(6, now);
  vibGain.gain.setValueAtTime(30, now);
  vib.connect(vibGain).connect(osc.frequency);

  gain.gain.setValueAtTime(0.0001, now);
  gain.gain.exponentialRampToValueAtTime(0.3, now + 0.05);
  gain.gain.exponentialRampToValueAtTime(0.001, now + 0.65);

  osc.connect(gain).connect(ctx.destination);
  osc.start(now);
  vib.start(now);
  osc.stop(now + 0.7);
  vib.stop(now + 0.7);
}

function playCrowd(){
  if(!$('#soundToggle')?.checked) return;
  const ctx = getAudio(); if(!ctx) return;
  const now = ctx.currentTime;

  const o1 = ctx.createOscillator();
  const o2 = ctx.createOscillator();
  const g = ctx.createGain();

  o1.type = 'sawtooth'; o2.type = 'sawtooth';
  o1.frequency.setValueAtTime(220, now);
  o2.frequency.setValueAtTime(224, now);

  g.gain.setValueAtTime(0.0001, now);
  g.gain.linearRampToValueAtTime(0.05, now + 0.05);
  g.gain.linearRampToValueAtTime(0.0, now + 1.1);

  o1.connect(g); o2.connect(g); g.connect(ctx.destination);
  o1.start(now); o2.start(now);
  o1.stop(now + 1.2); o2.stop(now + 1.2);
}

// コンフェッティ
let confettiRAF = 0;
function fireConfetti(duration = 1200){
  if(!$('#fxToggle')?.checked) return;
  const canvas = document.getElementById('confettiCanvas');
  const ctx = canvas.getContext('2d');
  const dpr = Math.min(window.devicePixelRatio || 1, 2);
  const resize = ()=>{
    canvas.width = innerWidth * dpr;
    canvas.height = innerHeight * dpr;
    canvas.style.width = innerWidth + 'px';
    canvas.style.height = innerHeight + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  };
  resize();
  const onResize = ()=>resize();
  window.addEventListener('resize', onResize);

  const colors = ['#eafff4', '#1ea65f', '#14a055', '#ffd54f', '#ffffff'];
  const parts = [];
  const count = Math.min(180, Math.floor(innerWidth * 0.12));
  for(let i=0;i<count;i++){
    parts.push({
      x: Math.random()*innerWidth,
      y: -Math.random()*innerHeight*0.4,
      w: 6 + Math.random()*6,
      h: 10 + Math.random()*10,
      r: Math.random()*360,
      v: 60 + Math.random()*120,
      vr: -4 + Math.random()*8,
      c: colors[i % colors.length],
      sway: Math.random()*1.2 + 0.4,
      swayPhase: Math.random()*Math.PI*2
    });
  }

  let start = performance.now();
  canvas.style.display = 'block';

  function loop(t){
    const elapsed = t - start;
    ctx.clearRect(0,0,innerWidth,innerHeight);
    for(const p of parts){
      p.y += p.v * (1/60);
      p.r += p.vr;
      p.x += Math.sin((elapsed*0.002) + p.swayPhase) * p.sway;
      if(p.y > innerHeight + 20) { p.y = -20; p.x = Math.random()*innerWidth; }
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.r * Math.PI/180);
      ctx.fillStyle = p.c;
      ctx.fillRect(-p.w/2, -ph/2, p.w, p.h);
ctx.restore();
}

if(elapsed < duration){
  confettiRAF = requestAnimationFrame(loop);
}else{
  window.removeEventListener('resize', onResize);
  canvas.style.display = 'none';
  ctx.clearRect(0,0,innerWidth,innerHeight);
  cancelAnimationFrame(confettiRAF);
  confettiRAF = 0;
}
}
confettiRAF = requestAnimationFrame(loop);
}

/* =========
イベント
========= */

document.getElementById('fillSample').addEventListener('click', ()=>{
const samples = ['こうたろう','けんすけ','りゅうき','りゅうま'];
for(let i=1;i<=8;i++){
document.getElementById('name-'+i).value = samples[i-1] || '';
const gk = document.getElementById('gk-'+i);
const fp = document.getElementById('fp-'+i);
if(gk) gk.checked = false;
if(fp) fp.checked = false;
}
document.getElementById('seed').value = '';
document.getElementById('result').style.display = 'none';
document.getElementById('error').style.display = 'none';
});

document.getElementById('clearAll').addEventListener('click', ()=>{
for(let i=1;i<=8;i++){
document.getElementById('name-'+i).value = '';
const gk = document.getElementById('gk-'+i);
const fp = document.getElementById('fp-'+i);
if(gk) gk.checked = false;
if(fp) fp.checked = false;
}
document.getElementById('matchCount').value = 3;
document.getElementById('seed').value = '';
document.getElementById('result').style.display = 'none';
document.getElementById('error').style.display = 'none';
});

document.getElementById('gen').addEventListener('click', async ()=>{
const genBtn = document.getElementById('gen');
const names = getUniqueNames();
const matchCount = parseInt(document.getElementById('matchCount').value, 10);
const seedStr = document.getElementById('seed').value.trim();
const err = document.getElementById('error');

err.style.display = 'none';
err.textContent = '';
genBtn.disabled = true;

try{
const presetInfo = readFirstMatchPreset(names);
const data = generateSchedule(names, matchCount, seedStr, presetInfo.preset);
if(presetInfo.warnings.length){
data.warnings.unshift(...presetInfo.warnings);
}

// サッカー演出（ONのとき）
if(document.getElementById('fxToggle')?.checked){
  await kickoffCountdown();
}

renderResult(data);

if(document.getElementById('fxToggle')?.checked){
  playWhistle();
  playCrowd();
  fireConfetti(1400);
}
}catch(e){
err.style.display = 'block';
err.textContent = e?.message || '入力エラー';
document.getElementById('result').style.display = 'none';
}finally{
genBtn.disabled = false;
}
});

document.getElementById('copyText').addEventListener('click', ()=>{
const matchesEl = document.getElementById('matches');
if(!matchesEl || matchesEl.children.length === 0){
alert('先にスケジュールを作成してください。');
return;
}
const data = collectCurrentData();
const text = buildTextOutput(data);
copyToClipboard(text);
});

document.getElementById('shareBtn').addEventListener('click', async ()=>{
const matchesEl = document.getElementById('matches');
if(!matchesEl || matchesEl.children.length === 0){
alert('先にスケジュールを作成してください。');
return;
}
const data = collectCurrentData();
const text = buildTextOutput(data);
if(navigator.share){
try{ await navigator.share({ text }); }catch(e){ /* キャンセル等は無視 */ }
}else{
copyToClipboard(text);
}
});
</script>

</body> </html>
